<script>

    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
    window.AudioContext = window.AudioContext || window.webkitAudioContext;

    var stage = new AudioContext;

    window.convolver = stage.createConvolver();

    var input = stage.createGain(),
        output = stage.createGain(),
        waveshaper = stage.createWaveShaper(),
        lowpass = stage.createBiquadFilter(),
        highpass = stage.createBiquadFilter(),
        boost = stage.createBiquadFilter(),
        cut = stage.createBiquadFilter();

    input.gain.value = 100;

    lowpass.type = "lowpass";
    lowpass.frequency.value = 5000;

    boost.type = "lowshelf";
    boost.frequency.value = 100;
    boost.gain.value = 6;

    cut.type = "lowshelf";
    cut.frequency.value = 100;
    cut.gain.value = -6;

    waveshaper.curve = makeDistortionCurve();
    waveshaper.oversample = '4x';

    highpass.type = "highpass";
    highpass.frequency.value = 20;


    function makeDistortionCurve() {
        var k = typeof amount === 'number' ? amount : 2000,
            x = 0,
            samples = 11025,
            curve = new Float32Array(samples);

        for (var i = 0; i < samples; ++i) {
            x = i * 2 / samples - 1;
//            curve[i] =  Math.max(-1, Math.min(1, x * k));
            curve[i] = Math.max(-0.5, Math.min(1.5, x * k));
        }

        console.log(curve);
        return curve;
    }
    ;


    navigator.getUserMedia({
        "audio": {
            "optional": [
                {"googEchoCancellation": "false"},
                {"googAutoGainControl": "false"},
                {"googNoiseSuppression": "true"},
                {"googHighpassFilter": "false"}
            ]
        }
    }, function (stream) {
        request = new XMLHttpRequest(),

            boost = stage.createGain();

//        request.open('GET', 'assets/ir/s-preshigh-16.wav', true);
//        request.open('GET', 'assets/ir/rectifier2.wav', true);
        request.open('GET', 'assets/ir/5150.wav', true);

        request.responseType = 'arraybuffer';

        request.onload = function () {
            stage.decodeAudioData(request.response, function (buffer) {
                window.convolver.buffer = buffer;
            }, function (e) {
                if (e) console.log("Cannot load cabinet" + e);
            });
        };

        request.send(null);

//        linein = stage.createMediaStreamSource(stream);
//        boost.gain.value = 5;
//
//        linein.connect(boost);
//        boost.connect(convolver);
//        convolver.connect(stage.destination);
//        linein = stage.createMediaStreamSource(stream);
//
//        linein.connect(boost);
//        boost.connect(stage.destination);
        window.source = stage.createMediaStreamSource(stream);

        source.connect(lowpass);
        lowpass.connect(boost);
        boost.connect(waveshaper);
        waveshaper.connect(cut);
        cut.connect(highpass);
        highpass.connect(convolver);
        convolver.connect(stage.destination);

    }, function (err) {
        console.error('Guitar stream failed: ' + err);
    });


</script>
